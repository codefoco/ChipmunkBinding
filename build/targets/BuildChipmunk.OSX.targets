<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <OSX32BuildDir>osx-32</OSX32BuildDir>
        <OSX64BuildDir>osx-64</OSX64BuildDir>
        <OSXBuildDir>osx</OSXBuildDir>
        <OSXBinaryLibraryPath64>lib64\libchipmunk.dylib</OSXBinaryLibraryPath64>
        <OSXBinaryLibraryPath32>lib\libchipmunk.dylib</OSXBinaryLibraryPath32>
        <OSXBinaryLibraryPath>libchipmunk.dylib</OSXBinaryLibraryPath>
        <XcodeWithout32BitSupport>10</XcodeWithout32BitSupport>
    </PropertyGroup>
    <Target Name="BuildChipmunkOSX" BeforeTargets="BeforeBuild" Condition="'$(OS)'=='Unix' and Exists('/usr/lib/libc.dylib')" >
         <Exec Command="xcodebuild -version | head -1" ConsoleToMSBuild="true">
            <Output TaskParameter="ConsoleOutput" PropertyName="OutputOfExec" />
         </Exec>
        <PropertyGroup>
            <CurrentXcodeVersion>$(OutputOfExec.Split(' ')[1].Split('.')[0])</CurrentXcodeVersion>
            <XcodeSupport32Bits Condition="$(CurrentXcodeVersion) &lt; $(XcodeWithout32BitSupport)">true</XcodeSupport32Bits>
            <XcodeSupport32Bits Condition="$(CurrentXcodeVersion) &gt; $(XcodeWithout32BitSupport) or $(CurrentXcodeVersion) == $(XcodeWithout32BitSupport)">false</XcodeSupport32Bits>
        </PropertyGroup>
        <Message Text="******* Xcode 10 doesn't support 32bits skipping 32 bit build ***" Condition="!$(XcodeSupport32Bits)" />
        <Message Text="Building macOS Chipmunk library" />
        <Exec Command="mkdir $(ExternalChipmunkPath)\$(OSXBuildDir)" WorkingDirectory="$(ExternalChipmunkPath)" Condition="!Exists('$(ExternalChipmunkPath)\$(OSXBuildDir)')" />
        <Exec Command="mkdir $(ExternalChipmunkPath)\$(OSX32BuildDir)" WorkingDirectory="$(ExternalChipmunkPath)" Condition="!Exists('$(ExternalChipmunkPath)\$(OSX32BuildDir)') and $(XcodeSupport32Bits) " />
        <Exec Command="mkdir $(ExternalChipmunkPath)\$(OSX64BuildDir)" WorkingDirectory="$(ExternalChipmunkPath)" Condition="!Exists('$(ExternalChipmunkPath)\$(OSX64BuildDir)')" />
        <Exec Command="cmake $(ExternalChipmunkPath) -DCMAKE_OSX_ARCHITECTURES=i386" WorkingDirectory="$(ExternalChipmunkPath)\$(OSX32BuildDir)" Condition="!Exists('$(ExternalChipmunkPath)\$(OSX32BuildDir)\CMakeCache.txt') and $(XcodeSupport32Bits)" />
        <Exec Command="cmake $(ExternalChipmunkPath) -DCMAKE_OSX_ARCHITECTURES=x86_64" WorkingDirectory="$(ExternalChipmunkPath)\$(OSX64BuildDir)" Condition="!Exists('$(ExternalChipmunkPath)\$(OSX64BuildDir)\CMakeCache.txt')" />
        <Exec Command="cmake --build . --config Release" WorkingDirectory="$(ExternalChipmunkPath)\$(OSX32BuildDir)" Condition="$(XcodeSupport32Bits)" />
        <Exec Command="cmake --build . --config Release" WorkingDirectory="$(ExternalChipmunkPath)\$(OSX64BuildDir)" />
        <Exec Command="lipo -create $(OSX64BuildDir)\$(OSXBinaryLibraryPath64) $(OSX32BuildDir)\$(OSXBinaryLibraryPath32) -output $(OSXBuildDir)\$(OSXBinaryLibraryPath)" WorkingDirectory="$(ExternalChipmunkPath)" Condition="$(XcodeSupport32Bits)"/>
        <Copy SourceFiles="$(ExternalChipmunkPath)\$(OSXBuildDir)\$(OSXBinaryLibraryPath)" DestinationFolder="$(OutputRuntimeDir)\$(OSXBuildDir)\native" SkipUnchangedFiles="true" Condition="$(XcodeSupport32Bits)"/>
        <Copy SourceFiles="$(ExternalChipmunkPath)\$(OSX64BuildDir)\$(OSXBinaryLibraryPath64)" DestinationFolder="$(OutputRuntimeDir)\$(OSXBuildDir)\native" SkipUnchangedFiles="true" Condition="!$(XcodeSupport32Bits)"/>
    </Target>
    <Target Name="CleanChipmunkOSX" AfterTargets="Clean" Condition="'$(OS)'=='Unix' and Exists('/usr/lib/libc.dylib')" >
        <Message Text="Cleaning Chipmunk library (osx)" />
        <RemoveDir Directories="
        $(ExternalChipmunkPath)\$(OSXBuildDir); 
        $(ExternalChipmunkPath)\$(OSX32BuildDir); 
        $(ExternalChipmunkPath)\$(OSX64BuildDir); 
        $(OutputRuntimeDir)\$(OSXBuildDir) " />
    </Target>
</Project>

